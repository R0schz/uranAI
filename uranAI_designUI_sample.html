<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>uranAI - Fortune Telling Salon</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&family=Noto+Sans+JP:wght@300;400&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-start: #1a1a2e;
            --bg-mid: #16213e;
            --bg-end: #0f3460;
            --primary-start: #c850c0;
            --primary-end: #4158d0;
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --header-height: 64px;
            --nav-height: 80px;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--bg-start) 0%, var(--bg-mid) 50%, var(--bg-end) 100%);
            color: #e3e3e3;
            overflow-x: hidden;
        }
        .font-serif-special { font-family: 'Shippori Mincho', serif; }
        #content-wrapper { padding-top: var(--header-height); padding-bottom: var(--nav-height); min-height: 100vh; box-sizing: border-box; }
        .page { min-height: calc(100vh - var(--header-height) - var(--nav-height)); width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .page.hidden { display: none; }
        .page-content { width: 100%; padding: 1rem; }
        #app-header, .nav-bar { background: rgba(15, 15, 25, 0.7); backdrop-filter: blur(10px); }
        #app-header { border-bottom: 1px solid var(--card-border); height: var(--header-height); }
        .nav-bar { border-top: 1px solid var(--card-border); height: var(--nav-height); }
        .nav-item.active { color: var(--primary-start); }
        .card { background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--card-border); border-radius: 1.5rem; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .btn-primary { background: linear-gradient(45deg, var(--primary-start), var(--primary-end)); transition: all 0.3s ease; box-shadow: 0 4px 15px 0 rgba(65, 88, 208, 0.4); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px 0 rgba(65, 88, 208, 0.5); }
        .form-input, .form-textarea { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--card-border); color: #fff; border-radius: 0.75rem; transition: border-color 0.3s ease; }
        .form-input:focus, .form-textarea:focus { outline: none; border-color: var(--primary-start); box-shadow: 0 0 0 2px rgba(200, 80, 192, 0.5); }
        .modal-overlay { background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); }
        .stars-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .star { position: absolute; background: #fff; border-radius: 50%; animation: twinkle 5s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        .glow-filter { filter: drop-shadow(0 0 8px rgba(200, 80, 192, 0.7)); }
        .gradient-text { background: linear-gradient(45deg, var(--primary-start), var(--primary-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Tarot Circular Shuffle Animation */
        .tarot-shuffle-container { width: 250px; height: 250px; position: relative; display: flex; align-items: center; justify-content: center; }
        .tarot-shuffle-card { width: 50px; height: 88px; background-size: cover; background-position: center; border-radius: 6px; border: 1px solid rgba(255,255,255,0.5); position: absolute; top: calc(50% - 44px); left: calc(50% - 25px); transform-origin: center; animation: tarot-circle-shuffle 3.5s ease-in-out forwards; }
        @keyframes tarot-circle-shuffle {
            0% { transform: rotate(0deg) translate(0) rotate(0deg); opacity: 1; }
            50% { transform: rotate(720deg) translate(100px) rotate(-720deg); opacity: 1; }
            100% { transform: rotate(0deg) translate(0) rotate(0deg); opacity: 0; }
        }
        
        /* Horoscope & Numerology Canvas */
        .loading-canvas { display: block; margin: auto; }
    </style>
</head>
<body class="antialiased">
    <!-- SVG Definitions -->
    <svg style="display: none;"><defs><symbol id="logo-icon" viewBox="0 0 100 100"><linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#c850c0;" /><stop offset="100%" style="stop-color:#4158d0;" /></linearGradient><filter id="iconGlow"><feGaussianBlur stdDeviation="1.5" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter><path d="M 50 5 A 45 45 0 1 0 50 95 A 35 35 0 1 1 50 5 Z" fill="url(#logoGrad)"></path><path d="M 60 25 L 70 45 L 55 55 L 75 70" stroke="white" stroke-width="1.5" fill="none" stroke-linecap="round" filter="url(#iconGlow)"></path><circle cx="60" cy="25" r="3.5" fill="white" filter="url(#iconGlow)"></circle><circle cx="70" cy="45" r="2.5" fill="white" filter="url(#iconGlow)"></circle><circle cx="55" cy="55" r="2" fill="white" filter="url(#iconGlow)"></circle><circle cx="75" cy="70" r="3" fill="white" filter="url(#iconGlow)"></circle></symbol></defs></svg>
    <div class="stars-bg" id="stars-container"></div>

    <!-- Header -->
    <header id="app-header" class="hidden fixed top-0 left-0 right-0 z-40 flex items-center justify-between px-4">
        <div data-action="back-to-home" class="flex items-center gap-2 cursor-pointer transition-opacity hover:opacity-80"><svg width="32" height="32" class="glow-filter"><use href="#logo-icon"></use></svg><span class="font-serif-special text-2xl">uran<span class="gradient-text font-bold">AI</span></span></div>
        <div id="header-user-status">
            <div id="free-user-header" class="flex items-center gap-4"><div class="flex items-center gap-1 text-yellow-300"><i data-lucide="ticket" class="w-5 h-5"></i><span id="header-ticket-count" class="font-bold text-lg">5</span></div><button data-action="show-premium-modal" class="bg-yellow-500/20 text-yellow-300 text-xs font-bold px-3 py-1 rounded-full border border-yellow-500/50 hover:bg-yellow-500/40 transition">プレミアム</button></div>
            <div id="premium-user-header" class="hidden"><div class="flex items-center gap-2 premium-text-glow"><i data-lucide="gem" class="w-5 h-5"></i><span class="text-lg">Premium</span></div></div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="app-container" class="relative">
        <div id="content-wrapper">
            <!-- All page sections here -->
            <section id="splash-screen" class="page p-4"><div class="page-content max-w-md mx-auto"><div class="text-center card p-8 md:p-12"><div class="flex flex-col items-center gap-4 mb-8"><svg width="100" height="100" class="glow-filter"><use href="#logo-icon"></use></svg><span class="font-serif-special text-5xl">uran<span class="gradient-text font-bold">AI</span></span></div><p class="text-gray-400 mb-10 px-4">あなたの未来を、<br>AIがそっと照らし出します。</p><button data-action="show-login" class="btn-primary text-white font-bold py-3 px-10 rounded-full text-lg shadow-lg">占いを始める</button></div></div></section>
            <section id="home-screen" class="page hidden p-4"><div class="page-content max-w-lg mx-auto"><h2 class="font-serif-special text-3xl text-center mb-10">占いの目的を選択</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div data-action="select-purpose" data-purpose="personal" class="card p-8 text-center cursor-pointer hover:border-purple-400 transition"><i data-lucide="user" class="w-16 h-16 mx-auto mb-4 text-purple-300"></i><h3 class="font-serif-special text-2xl mb-2">パーソナル鑑定</h3><p class="text-gray-400">あなた自身を<br>深く占います</p></div><div data-action="select-purpose" data-purpose="compatibility" class="card p-8 text-center cursor-pointer hover:border-cyan-400 transition"><i data-lucide="users" class="w-16 h-16 mx-auto mb-4 text-cyan-300"></i><h3 class="font-serif-special text-2xl mb-2">相性占い</h3><p class="text-gray-400">特定の人との相性を<br>占います</p></div></div></div></section>
            <section id="person-select-screen" class="page hidden p-4"><div class="page-content max-w-lg mx-auto"><h2 class="font-serif-special text-3xl text-center mb-4">人物を選択</h2><p id="person-select-description" class="text-center text-gray-400 mb-8">鑑定したい人物を選択してください。</p><div id="person-list" class="space-y-4 mb-6"></div><div class="text-center"><button data-action="show-add-person-from-select" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-full transition duration-300 flex items-center justify-center mx-auto"><i data-lucide="plus" class="w-5 h-5 mr-2"></i> 新しい人物を追加</button></div><div class="mt-10 text-center"><button data-action="confirm-person-selection" class="btn-primary text-white font-bold py-3 px-10 rounded-full text-lg shadow-lg opacity-50" disabled>次へ</button></div></div></section>
            <section id="fortune-type-screen" class="page hidden p-4"><div class="page-content max-w-2xl mx-auto"><h2 class="font-serif-special text-3xl text-center mb-10">占術を選択</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div data-action="select-fortune-type" data-type="numerology" class="card p-6 text-center cursor-pointer hover:border-purple-400 transition"><i data-lucide="binary" class="w-12 h-12 mx-auto mb-3 text-purple-300"></i><h3 class="font-serif-special text-xl mb-1">数秘術</h3><p class="text-sm text-gray-400">生年月日と名前から<br>運命を解読</p></div><div data-action="select-fortune-type" data-type="horoscope" class="card p-6 text-center cursor-pointer hover:border-cyan-400 transition"><i data-lucide="orbit" class="w-12 h-12 mx-auto mb-3 text-cyan-300"></i><h3 class="font-serif-special text-xl mb-1">西洋占星術</h3><p class="text-sm text-gray-400">星々の配置が示す<br>あなたの全て</p></div><div data-action="select-fortune-type" data-type="tarot" class="card p-6 text-center cursor-pointer hover:border-yellow-400 transition"><i data-lucide="layout-template" class="w-12 h-12 mx-auto mb-3 text-yellow-300"></i><h3 class="font-serif-special text-xl mb-1">タロット</h3><p class="text-sm text-gray-400">カードが導く<br>未来へのメッセージ</p></div><div data-action="select-fortune-type" data-type="comprehensive" class="card p-6 text-center cursor-pointer transition relative overflow-hidden" data-premium="true"><div class="absolute top-2 right-2 bg-yellow-500 text-black text-xs font-bold px-2 py-1 rounded-full flex items-center"><i data-lucide="gem" class="w-3 h-3 mr-1"></i> PREMIUM</div><i data-lucide="sparkles" class="w-12 h-12 mx-auto mb-3 text-yellow-300"></i><h3 class="font-serif-special text-xl mb-1">総合占い</h3><p class="text-sm text-gray-400">全ての占術で<br>多角的に鑑定</p></div></div></div></section>
            <section id="input-screen" class="page hidden p-4"><div class="page-content max-w-lg mx-auto"><h2 id="input-title" class="font-serif-special text-3xl text-center mb-8">情報入力</h2><div id="input-fields" class="space-y-6"></div><div class="mt-10 text-center"><button data-action="get-fortune" class="btn-primary text-white font-bold py-3 px-10 rounded-full text-lg shadow-lg">鑑定する</button></div></div></section>
            <section id="tarot-touch-screen" class="page hidden p-4"><div class="page-content max-w-md mx-auto text-center"><h2 class="font-serif-special text-2xl mb-8">心を静かに</h2><p class="text-gray-300 mb-10">占いたいことについて思い浮かべ、<br>カードに触れてください。</p><div data-action="touch-tarot-card" id="tarot-back-card" class="mx-auto w-40 h-72 bg-gray-800 rounded-2xl border-4 border-purple-400/50 p-2 shadow-2xl cursor-pointer transition-transform hover:scale-105 bg-cover bg-center"></div></div></section>
            <section id="result-screen" class="page hidden p-4"><div class="page-content max-w-2xl mx-auto"><div class="card p-6 md:p-8"><p class="text-xs text-center text-gray-500 mb-6">免責事項: 本占いはエンターテイメントを目的としたものであり、<br>その結果を保証するものではありません。</p><h2 id="result-title" class="font-serif-special text-3xl text-center mb-6 border-b border-gray-700 pb-4">星からの神託</h2><div id="visual-result-area" class="mb-8"></div><h3 class="font-serif-special text-xl mb-4 text-purple-300">AIによる鑑定文</h3><div id="ai-result-text" class="text-gray-300 leading-relaxed space-y-4 bg-black bg-opacity-20 p-4 rounded-lg"><p>星々の配置が示すところによると、<br>あなたの進む道には新たな光が差し込んでいます。</p><p>特に人間関係において、予期せぬ出会いが訪れる兆し。<br>それはまるで夜空に流れる星のように一瞬の輝きかもしれませんが、あなたの心に深い印象を残すでしょう。</p></div><div class="mt-8 flex flex-col md:flex-row gap-4 justify-center"><button data-action="share-result" class="bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 px-6 rounded-full transition duration-300 flex items-center justify-center"><i data-lucide="share-2" class="w-5 h-5 mr-2"></i> 結果を共有する</button><button data-action="ask-ai-more" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-6 rounded-full transition duration-300 flex items-center justify-center"><i data-lucide="message-circle" class="w-5 h-5 mr-2"></i> AIに追加質問する</button></div><div class="mt-8 text-center"><button data-action="back-to-home" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-full transition duration-300">ホームに戻る</button></div></div></div></section>
            <section id="mypage-screen" class="page hidden p-4"><div class="page-content max-w-lg mx-auto"><h2 class="font-serif-special text-3xl text-center mb-8">マイページ</h2><div class="card p-6 mb-8"><h3 class="font-serif-special text-xl mb-4">チケット情報</h3><div class="flex items-center justify-between"><p class="text-gray-300">現在のチケット枚数:</p><p class="text-3xl font-bold text-yellow-300 flex items-center"><i data-lucide="ticket" class="w-8 h-8 mr-2"></i><span id="ticket-count">5</span></p></div><p class="text-xs text-gray-500 mt-4">パーソナル鑑定は1日1回無料です。</p></div><div class="card p-6"><div class="flex justify-between items-center mb-4"><h3 class="font-serif-special text-xl">人物情報管理</h3><button data-action="show-add-person-from-mypage" class="bg-purple-600 hover:bg-purple-500 text-white p-2 rounded-full"><i data-lucide="plus" class="w-5 h-5"></i></button></div><p class="text-sm text-gray-400 mb-4">登録人数: <span id="person-count-info">1 / 3</span></p><div id="mypage-person-list" class="space-y-3"></div></div><div id="premium-banner" class="mt-8"><div class="card p-6 border-2 border-yellow-500 border-dashed"><h3 class="font-serif-special text-xl mb-2 text-yellow-300">プレミアムプラン</h3><p class="text-gray-400 mb-4">全ての機能を<br>無制限に利用できます。</p><button data-action="show-premium-modal" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-full transition">詳しく見る</button></div></div></div></section>
            
            <!-- LOADING SCREENS -->
            <section id="tarot-loading-screen" class="page hidden p-4"><div class="page-content flex flex-col items-center justify-center"><div class="tarot-shuffle-container"></div><p class="font-serif-special text-xl text-gray-200 mt-12 animate-pulse">運命を読み解いています...</p></div></section>
            <section id="horoscope-loading-screen" class="page hidden p-4"><div class="page-content flex flex-col items-center justify-center"><canvas id="star-trail-canvas" class="loading-canvas"></canvas><p class="font-serif-special text-xl text-gray-200 mt-12 animate-pulse">星々の配置を計算しています...</p></div></section>
            <section id="numerology-loading-screen" class="page hidden p-4"><div class="page-content flex flex-col items-center justify-center"><canvas id="matrix-canvas" class="loading-canvas"></canvas><p class="font-serif-special text-xl text-gray-200 mt-12 animate-pulse">運命数を算出しています...</p></div></section>
        </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <nav id="nav-bar" class="hidden fixed bottom-0 left-0 right-0 nav-bar flex justify-around items-center z-40">
        <div data-action="navigate" data-target="home-screen" class="nav-item text-center text-gray-400 cursor-pointer active"><i data-lucide="home" class="w-7 h-7 mx-auto"></i><span class="text-xs">ホーム</span></div>
        <div data-action="navigate" data-target="mypage-screen" class="nav-item text-center text-gray-400 cursor-pointer"><i data-lucide="user-circle" class="w-7 h-7 mx-auto"></i><span class="text-xs">マイページ</span></div>
    </nav>
    
    <!-- Modal Area -->
    <div id="modal-container" class="hidden fixed inset-0 z-50"></div>

    <script>
        lucide.createIcons();
        // ★★★ タロットカード裏面の画像URLをここで指定できます ★★★
        const tarotCardBackUrl = 'https://placehold.co/100/176/1a1a2e/c850c0?text=uranAI';

        const state = { isLoggedIn: false, isPremium: false, currentScreen: 'splash-screen', tickets: 5, fortunePurpose: null, selectedPeople: [], fortuneType: null, people: [{ id: 1, nickname: 'あなた', name: 'てすと はなこ', gender: 'female', birthDate: '1998-11-10', birthTime: '14:30', birthPlace: '東京都渋谷区' }], nextPersonId: 2, };
        const Templates = {
            loginModal: () => `<div class="modal-overlay fixed inset-0" data-action="close-modal"></div><div class="bg-gray-900/95 border border-gray-700 rounded-2xl w-full max-w-sm mx-auto fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8"><h2 class="font-serif-special text-2xl text-center mb-6">ログイン/新規登録</h2><div class="space-y-4"><input class="form-input w-full p-3" type="email" placeholder="メールアドレス"><input class="form-input w-full p-3" type="password" placeholder="パスワード"><button data-action="login" class="btn-primary w-full text-white font-bold py-3 rounded-full">ログイン</button><p class="text-center text-sm text-gray-400">または</p><button class="w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-full">新規登録</button></div></div>`,
            personCard: (p, is) => `<div data-person-id="${p.id}" class="person-card card p-4 flex items-center justify-between cursor-pointer transition ${is?'border-purple-400':''}"><div class="flex items-center"><div class="w-12 h-12 rounded-full bg-purple-900 flex items-center justify-center mr-4"><span class="text-xl font-bold">${p.nickname.charAt(0)}</span></div><div><p class="font-bold text-lg">${p.nickname}</p><p class="text-sm text-gray-400">${p.birthDate||'生年月日未登録'}</p></div></div><div class="select-indicator w-6 h-6 rounded-full border-2 ${is?'bg-purple-500 border-purple-400':'border-gray-500'}"></div></div>`,
            myPagePersonItem: (p) => `<div class="bg-black bg-opacity-20 p-3 rounded-lg flex items-center justify-between"><p>${p.nickname}</p><div><button class="text-gray-400 hover:text-white p-1"><i data-lucide="edit" class="w-4 h-4"></i></button><button data-action="delete-person" data-person-id="${p.id}" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div>`,
            addPersonModal: () => `<div class="modal-overlay fixed inset-0" data-action="close-modal"></div><div class="card w-full max-w-md mx-auto fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8"><h2 class="font-serif-special text-2xl text-center mb-6">新しい人物を登録</h2><form id="add-person-form" class="space-y-4"><input name="nickname" class="form-input w-full p-3" type="text" placeholder="ニックネーム *" required><input name="name" class="form-input w-full p-3" type="text" placeholder="名前（ひらがな）"><input name="birthDate" class="form-input w-full p-3" type="date"><div class="text-center mt-6"><button type="submit" class="btn-primary text-white font-bold py-3 px-8 rounded-full">登録する</button></div></form></div>`,
            confirmNewPersonModal: (n) => `<div class="modal-overlay fixed inset-0" data-action="close-modal"></div><div class="card w-full max-w-sm mx-auto fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 text-center"><h2 class="font-serif-special text-xl mb-4">人物を登録しますか？</h2><p class="text-gray-300 mb-6">新しい人物「${n}」さんを<br>マイページに登録します。</p><div class="flex gap-4 justify-center"><button data-action="close-modal" class="btn-secondary text-white font-bold py-2 px-6 rounded-full">あとで</button><button data-action="confirm-add-new-person" class="btn-primary font-bold py-2 px-6 rounded-full">登録する</button></div></div>`,
            premiumPromptModal: (r) => `<div class="modal-overlay fixed inset-0" data-action="close-modal"></div><div class="card w-full max-w-sm mx-auto fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 text-center border-2 premium-glow"><i data-lucide="gem" class="w-12 h-12 mx-auto mb-4 text-yellow-300"></i><h2 class="font-serif-special text-xl mb-4">プレミアムプラン限定機能</h2><p class="text-gray-300 mb-6">${r}</p><button data-action="show-premium-modal-from-prompt" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-full transition mb-2">プレミアムプランを見る</button><button data-action="close-modal" class="text-sm text-gray-400">閉じる</button></div>`,
            ticketPromptModal: () => `<div class="modal-overlay fixed inset-0" data-action="close-modal"></div><div class="card w-full max-w-sm mx-auto fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-8 text-center"><i data-lucide="ticket" class="w-12 h-12 mx-auto mb-4 text-yellow-300"></i><h2 class="font-serif-special text-xl mb-4">チケットが不足しています</h2><p class="text-gray-300 mb-6">この機能を利用するには<br>チケットが1枚必要です。</p><div class="space-y-3"><button class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-full">広告を視聴してチケット獲得</button><button data-action="show-premium-modal-from-prompt" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-full">プレミアムプランに登録</button></div></div>`,
            inputField: (n, l, t, p, v = '') => `<div><label class="block text-sm font-medium text-gray-400 mb-2">${l}</label><input name="${n}" type="${t}" placeholder="${p}" value="${v}" class="form-input w-full p-3"></div>`,
            textareaField: (n, l, p) => `<div><label class="block text-sm font-medium text-gray-400 mb-2">${l}</label><textarea name="${n}" placeholder="${p}" class="form-textarea w-full p-3 h-32 resize-none"></textarea></div>`,
            visuals: {
                numerology: () => `<h3 class="font-serif-special text-xl mb-6 text-purple-300 text-center">あなたのナンバー</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center">${['ライフパス','ディスティニー','ソウル','パーソナル','バースデー','マチュリティー'].map(n=>`<div class="bg-black bg-opacity-20 p-4 rounded-lg"><p class="text-sm text-gray-400">${n}</p><p class="font-serif-special text-3xl font-bold">${Math.floor(Math.random()*9)+1}</p></div>`).join('')}</div>`,
                horoscope: () => `<h3 class="font-serif-special text-xl mb-4 text-cyan-300 text-center">ホロスコープチャート</h3><img src="https://placehold.co/400x400/1a1a2e/e3e3e3?text=Horoscope+Chart" alt="Horoscope Chart" class="mx-auto rounded-full">`,
                tarot: () => `<h3 class="font-serif-special text-xl mb-6 text-yellow-300 text-center">ケルト十字スプレッド</h3><div class="grid grid-cols-3 sm:grid-cols-4 gap-2 justify-items-center">${Array.from({length:10}).map((_,i)=>`<div class="w-20"><img src="https://placehold.co/100x170/4158d0/ffffff?text=Card${i+1}" class="rounded-md ${i%3===0?'transform rotate-90':''}"></div>`).join('')}</div>`
            }
        };
        const UI = {
            switchScreen: (id) => { document.querySelectorAll('.page').forEach(p => p.classList.toggle('hidden', p.id !== id)); state.currentScreen = id; window.scrollTo(0, 0); },
            showModal: (h) => { const mc = document.getElementById('modal-container'); mc.innerHTML = h; mc.classList.remove('hidden'); lucide.createIcons(); },
            closeModal: () => { const mc = document.getElementById('modal-container'); mc.classList.add('hidden'); mc.innerHTML = ''; },
            updateHeader: () => { const f = document.getElementById('free-user-header'), p = document.getElementById('premium-user-header'), t = document.getElementById('header-ticket-count'); if (state.isPremium) { f.classList.add('hidden'); p.classList.remove('hidden'); } else { f.classList.remove('hidden'); p.classList.add('hidden'); t.textContent = state.tickets; } lucide.createIcons(); },
            updateNavBar: (id) => { document.querySelectorAll('.nav-item').forEach(i => i.classList.toggle('active', i.dataset.target === id)); },
            renderPersonSelect: () => { const l = document.getElementById('person-list'); l.innerHTML = state.people.map(p => Templates.personCard(p, state.selectedPeople.includes(p.id))).join(''); document.querySelectorAll('.person-card').forEach(c => c.addEventListener('click', Handlers.selectPerson)); document.getElementById('person-select-description').textContent = state.fortunePurpose === 'personal' ? '鑑定したい人物を1人選択してください。' : `鑑定したい人物を2人選択してください。(${state.selectedPeople.length}/2)`; const n = document.querySelector('[data-action="confirm-person-selection"]'), r = state.fortunePurpose === 'personal' ? 1 : 2, i = state.selectedPeople.length === r; n.disabled = !i; n.classList.toggle('opacity-50', !i); },
            renderMyPage: () => { document.getElementById('ticket-count').textContent = state.tickets; document.getElementById('person-count-info').textContent = `${state.people.length} / ${state.isPremium?'無制限':'3'}`; document.getElementById('mypage-person-list').innerHTML = state.people.map(Templates.myPagePersonItem).join(''); lucide.createIcons(); document.getElementById('premium-banner').style.display = state.isPremium ? 'none' : 'block'; },
            renderInputScreen: () => { const t = document.getElementById('input-title'), f = document.getElementById('input-fields'); f.innerHTML = ''; const p1 = state.people.find(p => p.id === state.selectedPeople[0]); const ft = { numerology: { title: '数秘術', fields: () => { let h=Templates.inputField('name1','名前(ひらがな)','text','てすと はなこ',p1.name)+Templates.inputField('birthDate1','生年月日','date','',p1.birthDate); if (state.fortunePurpose==='compatibility') { const p2=state.people.find(p=>p.id===state.selectedPeople[1]); h+=`<hr class="border-gray-700 my-4">`+Templates.inputField('name2','相手の名前(ひらがな)','text','てすと たろう',p2?.name||'')+Templates.inputField('birthDate2','相手の生年月日','date','',p2?.birthDate||''); } return h+Templates.textareaField('question','相談内容 (任意)','今年の恋愛運は？'); } }, horoscope: { title: '西洋占星術', fields: () => Templates.inputField('name1','名前(ひらがな)','text','てすと はなこ',p1.name)+Templates.inputField('birthDate1','出生年月日','date','',p1.birthDate)+Templates.inputField('birthTime1','出生時刻','time','',p1.birthTime)+Templates.inputField('birthPlace1','出生場所','text','例: 東京都中央区',p1.birthPlace)+Templates.textareaField('question','相談内容 (任意)','今日の運勢は？') }, tarot: { title: 'タロット', fields: () => Templates.textareaField('question','占いたいこと','今の仕事についてアドバイスが欲しい') } }; const c = ft[state.fortuneType]; if (c) { t.textContent = c.title; f.innerHTML = c.fields(); } },
            renderResultScreen: () => { const t = document.getElementById('result-title'), v = document.getElementById('visual-result-area'), f = { numerology: '数秘術', horoscope: '西洋占星術', tarot: 'タロット', comprehensive: '総合占い' }; t.textContent = `${f[state.fortuneType]}の鑑定結果`; v.innerHTML = Templates.visuals[state.fortuneType] ? Templates.visuals[state.fortuneType]() : `<div class="text-center text-gray-400">複数の占術結果を統合しています...</div>`; }
        };
        const Handlers = {
            handleAppClick: (e) => { const t = e.target.closest('[data-action]'); if (!t) return; const a = t.dataset.action; const actions = { 'show-login': () => UI.showModal(Templates.loginModal()), 'close-modal': UI.closeModal, 'login': Handlers.login, 'navigate': () => { UI.switchScreen(t.dataset.target); UI.updateNavBar(t.dataset.target); if (t.dataset.target === 'mypage-screen') UI.renderMyPage(); }, 'select-purpose': () => { state.fortunePurpose = t.dataset.purpose; state.selectedPeople = []; UI.renderPersonSelect(); UI.switchScreen('person-select-screen'); }, 'confirm-person-selection': () => UI.switchScreen('fortune-type-screen'), 'select-fortune-type': () => Handlers.selectFortuneType(t.dataset.type, t.dataset.premium), 'get-fortune': Handlers.getFortune, 'back-to-home': () => { Object.assign(state, { selectedPeople: [], fortunePurpose: null, fortuneType: null }); UI.switchScreen('home-screen'); UI.updateNavBar('home-screen'); }, 'share-result': () => Handlers.useTicketAction('共有'), 'ask-ai-more': () => Handlers.useTicketAction('追加質問'), 'show-add-person-from-mypage': Handlers.showAddPerson, 'show-add-person-from-select': Handlers.showAddPerson, 'delete-person': () => Handlers.deletePerson(parseInt(t.dataset.personId)), 'show-premium-modal': () => UI.showModal(Templates.premiumPromptModal('プレミアムプランに登録すると、<br>占い・質問・共有が無制限になり、<br>広告も非表示になります。')), 'show-premium-modal-from-prompt': () => UI.showModal(Templates.premiumPromptModal('プレミアムプランに登録すると、<br>占い・質問・共有が無制限になり、<br>広告も非表示になります。')), 'touch-tarot-card': Handlers.startTarotShuffle }; actions[a]?.(); },
            login: () => { state.isLoggedIn = true; UI.closeModal(); UI.switchScreen('home-screen'); document.getElementById('app-header').classList.remove('hidden'); document.getElementById('nav-bar').classList.remove('hidden'); UI.updateHeader(); },
            selectPerson: (e) => { const id = parseInt(e.currentTarget.dataset.personId), max = state.fortunePurpose === 'personal' ? 1 : 2; if (state.selectedPeople.includes(id)) { state.selectedPeople = state.selectedPeople.filter(i => i !== id); } else { if (state.selectedPeople.length < max) state.selectedPeople.push(id); else if (max === 1) state.selectedPeople = [id]; } UI.renderPersonSelect(); },
            selectFortuneType: (type, isPremium) => { if (isPremium && !state.isPremium) { UI.showModal(Templates.premiumPromptModal('総合占いはプレミアム会員限定の機能です。')); return; } state.fortuneType = type; UI.renderInputScreen(); UI.switchScreen('input-screen'); },
            getFortune: () => { const n = document.querySelector('#input-screen input[name="nickname1"]'); if (n) { const nick = n.value.trim(); if (!state.people.some(p => p.nickname === nick)) { if (!state.isPremium && state.people.length >= 3) { UI.showModal(Templates.premiumPromptModal('新しい人物を登録するには<br>プレミアム登録が必要です。')); return; } setTimeout(() => UI.showModal(Templates.confirmNewPersonModal(nick)), 4000); } } const loadingScreens = { tarot: 'tarot-loading-screen', horoscope: 'horoscope-loading-screen', numerology: 'numerology-loading-screen', comprehensive: 'tarot-loading-screen' }; const screen = loadingScreens[state.fortuneType]; if (state.fortuneType === 'tarot') { document.getElementById('tarot-back-card').style.backgroundImage = `url(${tarotCardBackUrl})`; UI.switchScreen('tarot-touch-screen'); return; } Handlers.startLoadingAnimation(screen, 3500); },
            startLoadingAnimation: (screenId, duration) => { UI.switchScreen(screenId); const animation = Animations[screenId]; if(animation) animation.start(); setTimeout(() => { if(animation) animation.stop(); UI.renderResultScreen(); UI.switchScreen('result-screen'); }, duration); },
            startTarotShuffle: () => { Handlers.startLoadingAnimation('tarot-loading-screen', 3500); },
            useTicketAction: (name) => { if (state.tickets > 0) { state.tickets--; UI.updateHeader(); alert(`${name}しました。(チケットを1枚消費しました)`); } else { UI.showModal(Templates.ticketPromptModal()); } },
            showAddPerson: () => { if (!state.isPremium && state.people.length >= 3) { UI.showModal(Templates.premiumPromptModal('無料会員が登録できる人物は<br>3人までです。')); } else { UI.showModal(Templates.addPersonModal()); } },
            handleAddPerson: (e) => { e.preventDefault(); const fd = new FormData(e.target); const p = { id: state.nextPersonId++, nickname: fd.get('nickname'), name: fd.get('name'), birthDate: fd.get('birthDate') }; state.people.push(p); UI.closeModal(); if (state.currentScreen === 'mypage-screen') UI.renderMyPage(); else if (state.currentScreen === 'person-select-screen') UI.renderPersonSelect(); },
            deletePerson: (id) => { if (confirm('この人物を削除しますか？')) { state.people = state.people.filter(p => p.id !== id); UI.renderMyPage(); } }
        };
        const Animations = {
            'tarot-loading-screen': {
                start: () => { const container = document.querySelector('.tarot-shuffle-container'); container.innerHTML = ''; for(let i=0; i<8; i++){ const card = document.createElement('div'); card.className = 'tarot-shuffle-card'; card.style.animationDelay = `${i * 0.1}s`; card.style.backgroundImage = `url(${tarotCardBackUrl})`; container.appendChild(card); } },
                stop: () => {}
            },
            'horoscope-loading-screen': {
                animationFrameId: null,
                start: () => {
                    const canvas = document.getElementById('star-trail-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 300;
                    canvas.height = 300;
                    let stars = [];
                    const numStars = 200;
                    for (let i = 0; i < numStars; i++) {
                        stars.push({ x: canvas.width / 2, y: canvas.height / 2, radius: Math.random() * 1.5 + 0.5, arcRadius: Math.random() * (canvas.width / 2 - 10) + 10, angle: Math.random() * Math.PI * 2, speed: (Math.random() - 0.5) * 0.04 });
                    }
                    function draw() {
                        // --- 編集箇所 ---
                        // 背景を完全にクリアし、無色透明にする
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        // --- 編集箇所ここまで ---
                        stars.forEach(star => {
                            const currentX = canvas.width / 2 + Math.cos(star.angle) * star.arcRadius;
                            const currentY = canvas.height / 2 + Math.sin(star.angle) * star.arcRadius;
                            ctx.beginPath();
                            ctx.arc(currentX, currentY, star.radius, 0, Math.PI * 2);
                            ctx.fillStyle = `rgba(255, 255, 255, ${Math.random() * 0.5 + 0.5})`;
                            ctx.shadowColor = 'white';
                            ctx.shadowBlur = 10;
                            ctx.fill();
                            star.angle += star.speed;
                        });
                        Animations['horoscope-loading-screen'].animationFrameId = requestAnimationFrame(draw);
                    }
                    draw();
                },
                stop: () => { cancelAnimationFrame(Animations['horoscope-loading-screen'].animationFrameId); }
            },
            'numerology-loading-screen': {
                intervalId: null,
                start: () => {
                    const canvas = document.getElementById('matrix-canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 300;
                    canvas.height = 300;
                    const letters = '0123456789';
                    // --- 編集箇所 ---
                    const fontSize = 16; // フォントサイズを小さくして密度を上げる
                    const columns = canvas.width / fontSize;
                    // 各列の開始位置をランダムに設定し、より「絶え間ない」流れを演出
                    let drops = Array.from({ length: Math.floor(columns) }).map(() => 1 + Math.floor(Math.random() * 250));
                    // --- 編集箇所ここまで ---

                    function draw() {
                        // 背景を完全にクリアして透明にする
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.fillStyle = '#c850c0';
                        ctx.font = `${fontSize}px monospace`;
                        for (let i = 0; i < drops.length; i++) {
                            const text = letters[Math.floor(Math.random() * letters.length)];
                            ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                            // 画面下部に達したら、ランダムに上部に戻す
                            if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                                drops[i] = 0;
                            }
                            drops[i]++;
                        }
                    }
                    // 描画間隔を短くして、流れを速く、滑らかにする
                    Animations['numerology-loading-screen'].intervalId = setInterval(draw, 33);
                },
                stop: () => { clearInterval(Animations['numerology-loading-screen'].intervalId); }
            }
        };
        const init = () => {
            const sc = document.getElementById('stars-container');
            for (let i = 0; i < 100; i++) { const s = document.createElement('div'); s.className = 'star'; const z = Math.random() * 3 + 1; s.style.cssText = `width:${z}px;height:${z}px;top:${Math.random()*100}%;left:${Math.random()*100}%;animation-delay:${Math.random()*5}s;animation-duration:${Math.random()*3+4}s;`; sc.appendChild(s); }
            const er = document.documentElement; er.addEventListener('click', Handlers.handleAppClick); er.addEventListener('submit', (e) => { if (e.target.id === 'add-person-form') Handlers.handleAddPerson(e); });
            UI.switchScreen('splash-screen'); UI.updateHeader();
        };
        init();
    </script>
</body>
</html>
